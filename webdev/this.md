---
title: Про этот сайт
lang: ru
---

Upd.: по состоянию на 2020, всё не так. Я просто юзаю Jekyll.
Стили, которые были на LESS, я переделал на SASS. Вроде нормально.

---

Свою первую домашнюю страничку я сделал в 1996 году.
Это была именно что страничка
(или, как модно сейчас говорить, «одностраничный сайт»)
и весь текст на ней помещался в одном большом блоке `<pre>`.

Веб-разработкой я стал заниматься в 1999,
и с тех пор у меня было много всяких там «домашних страничек» и «личных сайтов».
Этот домен (`kastaneda.kiev.ua`) у меня появился в 2001-м году
с лёгкой руки камрада Змеюки.
Так оно и живёт.
Я перепробовал много технологий и вариантов дизайна.
«Движков» было несколько, все на PHP и все самодельные.

Нынешняя версия сайта вообще не использует никаких движков.
Только хитрая система сборки.

Как устроен этот сайт
---------------------

Этот сайт полностью статический. Его можно раздавать через CDN, для него
достаточно «лёгких» httpd вроде nginx, а с учётом небольшого веса этот сайт
можно хостить даже на домашнем роутере.

При этом лично мне очень удобно возиться с содержимым сайта.
Я пишу этот текст в формате Markdown при помощи текстового редактора.
Это на 38% удобнее,
чем писать текст в веб-интерфейсе админки любой из известных мне CMS.
Никакая `<textarea>` не сможет дать мне всего того, что у меня есть
в полноценном текстовом редакторе.

Всё это вместе взятое (тексты сайта, оформление и система сборки)
хранится в [Git-репозитории][1].

Теоретически у меня есть возможность публиковать материалы при помощи
одного лишь браузера (почти как в обычных database-driven CMS).
В любом интернет-кафе я могу залогиниться на GitHub'е и прямо там,
в веб-интерфейсе, _сделать новый коммит_.
Как запасной вариант сойдёт.

Система сборки
--------------

HTML-страницы собираются из Markdown'а при помощи программы [Pandoc][2]
(а также GNU make и набора моих скриптов). Как при компиляции,
make обходит все исходные файлы
(в моём случае это файлы с расширением «.md»)
и, если требуется, обновляет результирующие страницы.

Работает это, упрощая, приблизительно вот так:

```makefile
# apt-get install pandoc
PANDOC = pandoc --from markdown --to html5 --css style.css --standalone

SOURCE_PAGES = $(shell find . -type f -name '*.md')
TARGET_PAGES = $(patsubst %.md,%.html,$(SOURCE_PAGES))

all: $(TARGET_PAGES)

%.html: %.md
	$(PANDOC) $< --output $@
```

Чистый CSS писать вручную я не люблю, это бывает утомительно.
Я предпочитаю препроцессоры, добавляющие к CSS удобные
расширения синтаксиса — в частности, [LESS][3].
Само собой, CSS из LESS также делается при помощи make:

```makefile
# apt-get install node-less
LESSC = lessc --compress

style.css: style.less
	$(LESSC) $< > $@
```

Кроме CSS, у меня собирается [sitemap.xml][4].

В реально использующемся Makefile всё устроено [чуть сложнее][5],
чем в этих примерах, но в целом принцип такой же.

Как бы «Continuous Integration»
-------------------------------

У меня есть автоматическая сборка сайта. Работает это так:

 1. Я делаю git push на GitHub
    (или делаю коммит через веб-интерфейс GitHub).
 2. GitHub вызывает [Post-Receive WebHook][6].
 3. У меня на билд-сервере этот WebHook
    вызывает скрипт какого-то такого вида:

```php
<?php echo touch('/home/gray/git/homepage/_build') ? 'OK' : 'Error';
```

 4. У меня на билд-сервере периодически по crontab'у
    вызывается [скрипт сборки][7]. Обнаружив флаг, говорящий
    о необходимости пересобрать сайт, скрипт он начинает сборку.
    В противном случае он молча выходит.
 5. Сайт обновлён.
 6. Отчёт о сборке cron присылает мне на почту.

[1]: https://github.com/kastaneda/kastaneda.kiev.ua
[2]: http://johnmacfarlane.net/pandoc/
[3]: http://lesscss.org/
[4]: http://en.wikipedia.org/wiki/Sitemaps
[5]: https://github.com/kastaneda/kastaneda.kiev.ua/blob/master/Makefile
[6]: https://help.github.com/articles/post-receive-hooks
[7]: https://github.com/kastaneda/kastaneda.kiev.ua/blob/master/build.sh
